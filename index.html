<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Maniek ‚Äî Pewny Przew√≥z</title>

<!-- EMAILJS (opcjonalnie) -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
  :root{
    --navy:#0f2b4c;
    --accent:#4FA3FF;
    --gold:#d4af37;
    --muted:#9fb3d6;
    --card:#172433;
    --white:#ffffff;
    --glass: rgba(255,255,255,0.03);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg, rgba(11,19,33,0.94) 0%, rgba(9,13,22,0.92) 100%), url('https://images.unsplash.com/photo-1503376780353-7e6692767b70?auto=format&fit=crop&w=1600&q=80') center/cover no-repeat fixed;
    color:var(--white);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    padding-bottom:80px;
  }

  header{
    background: rgba(15,43,76,0.92);
    border-bottom: 1px solid rgba(79,163,255,0.08);
    padding:18px 16px;
    position:sticky;
    top:0;
    z-index:40;
  }
  .container{ max-width:1100px; margin:0 auto; padding:0 16px; }
  .brand{ display:flex; align-items:center; gap:12px; }
  .logo { width:56px;height:56px;border-radius:10px;
    background:linear-gradient(135deg,var(--accent),#2b6ce3);
    display:flex;align-items:center;justify-content:center;font-weight:800;color:#072033;
    box-shadow:0 4px 20px rgba(0,0,0,0.6);
  }
  .brand h1{ margin:0; font-size:18px;line-height:1; color:var(--white) }
  .brand p{ margin:0;font-size:12px;color:var(--muted); }

  nav{ margin-left:auto; display:flex; gap:10px; align-items:center; }
  .btn {
    background:transparent;border:1px solid rgba(255,255,255,0.06); color:var(--white);
    padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;text-decoration:none;
  }
  .btn.primary{ background:var(--accent); color:#072033; border:none; }
  .btn.ghost{ background:transparent; }

  main{ padding:28px 0; }

  .grid{
    display:grid;
    grid-template-columns: 1fr 360px;
    gap:20px;
    align-items:start;
  }

  @media (max-width:960px){
    .grid{ grid-template-columns:1fr; padding:0 8px; }
    nav{ display:none; }
  }

  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border-radius:12px;
    padding:18px;
    box-shadow: 0 6px 20px rgba(2,6,23,0.6);
    border:1px solid rgba(255,255,255,0.03);
  }

  h2{ margin:0 0 10px 0; color:var(--accent); font-size:18px; }
  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; }
  input[type=text], input[type=email], input[type=tel], input[type=datetime-local], textarea, select, input[type=number]{
    width:100%; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.06);
    background:rgba(255,255,255,0.02); color:var(--white); outline:none; font-size:14px;
  }
  textarea{ min-height:90px; resize:vertical; }

  .form-row{ display:flex; gap:10px; }
  .form-row .col{ flex:1; }

  .submit {
    display:inline-block;padding:10px 14px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),#2b6ce3);
    color:#021224;font-weight:700;cursor:pointer;margin-top:8px;
  }

  .muted{ color:var(--muted); font-size:13px; margin-top:8px; }

  table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:14px; color:var(--muted);}
  th,td{ padding:8px 10px; border-bottom:1px dashed rgba(255,255,255,0.04); text-align:left; }
  th{ color:var(--muted); font-size:12px; text-transform:uppercase; letter-spacing:0.6px; }

  .chip{ background:rgba(255,255,255,0.03); padding:6px 10px; border-radius:999px; font-size:13px; display:inline-block; color:var(--muted); }

  .icons-row{ display:flex; gap:12px; justify-content:center; margin:14px 0; }
  .icon-box{ display:flex; flex-direction:column; align-items:center; gap:6px; padding:12px; border-radius:10px; background:rgba(255,255,255,0.02); width:120px; text-align:center;}
  .icon-emoji{ font-size:28px; }

  footer{ text-align:center; color:var(--muted); padding:24px 8px; margin-top:20px; }
  .small{ font-size:13px;color:var(--muted); }

  .opinie{ font-style:italic; opacity:0.95; font-size:15px; }
  .opinie-wrap{ display:flex; align-items:center; gap:12px; justify-content:space-between; }

  .ribbon{ position:fixed; right:14px; bottom:18px; background:var(--gold); color:#072033; padding:10px 14px; border-radius:999px; font-weight:700; box-shadow:0 6px 18px rgba(10,14,25,0.6); z-index:60; }

  /* rules + partners small helpers */
  .lang-flag { border-radius:3px; width:28px;height:20px; cursor:pointer; }
  .hidden { display:none !important; }

  /* CHATBOT (left floating) */
  #chatbot-widget {
    position: fixed;
    left: 18px;
    bottom: 20px;
    width: 320px;
    max-height: 520px;
    background: linear-gradient(180deg, rgba(10,26,47,0.98), rgba(6,12,23,0.98));
    color: white;
    border-radius: 12px;
    overflow: hidden;
    display:flex;
    flex-direction:column;
    z-index:99999;
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    font-family: Inter, Arial, sans-serif;
  }
  #chatbot-header { background: var(--gold); color:#061420; padding:10px 12px; font-weight:700; cursor:pointer; display:flex;align-items:center;justify-content:space-between; }
  #chatbot-messages { padding:12px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; }
  .chat-msg { max-width:78%; padding:8px 10px; border-radius:10px; font-size:14px; line-height:1.3; }
  .chat-bot { background: rgba(255,255,255,0.03); color:var(--white); align-self:flex-start; }
  .chat-user { background: var(--gold); color:#061420; align-self:flex-end; }
  #chatbot-input { display:flex; gap:8px; padding:10px; border-top:1px solid rgba(255,255,255,0.03); }
  #chatbot-input input { flex:1; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--white); }
  #chatbot-input button { padding:8px 12px; border-radius:8px; border:none; background:var(--gold); color:#061420; font-weight:700; cursor:pointer; }

  @media (max-width:560px){
    #chatbot-widget { left: 10px; width: 90%; bottom: 14px; }
  }

</style>
</head>
<body>

<header>
  <div class="container" style="display:flex;align-items:center;">
    <div class="brand">
      <div class="logo">MP</div>
      <div>
        <h1>Maniek ‚Äî Pewny Przew√≥z</h1>
        <p>Bezpiecznie. Na czas. Zawsze.</p>
      </div>
    </div>

    <nav>
      <a class="btn" href="#kierowca">O kierowcy</a>
      <a class="btn" href="#bezpieczenstwo">Bezpiecze≈Ñstwo</a>
      <a class="btn" href="#opinie">Opinie</a>
      <a class="btn primary" id="openPanelBtn">Panel kierowcy</a>
    </nav>
  </div>
</header>

<main class="container">
  <div class="grid">
    <!-- LEFT: Formularz + mapa + opinie -->
    <div>
      <div class="card" id="bookingCard">
        <h2>Zarezerwuj przejazd</h2>
        <p class="small muted">Wype≈Çnij formularz ‚Äî Maniek potwierdzi telefonicznie.</p>

        <form id="bookingForm" autocomplete="off">
          <div style="margin-top:12px;">
            <label for="name">Imiƒô i nazwisko</label>
            <input id="name" type="text" required placeholder="Jan Kowalski">
          </div>

          <div style="margin-top:10px;">
            <label for="phone">Telefon</label>
            <input id="phone" type="tel" required placeholder="+48 600 000 000">
          </div>

          <div style="margin-top:10px;">
            <label for="email">Email (opcjonalnie)</label>
            <input id="email" type="email" placeholder="kontakt@przyklad.pl">
          </div>

          <div class="form-row" style="margin-top:10px;">
            <div class="col">
              <label for="from">SkƒÖd (miasto/adres)</label>
              <input id="from" type="text" required placeholder="Pozna≈Ñ, ul. ≈öwiƒôta 1">
            </div>
            <div class="col">
              <label for="to">DokƒÖd (miasto/adres)</label>
              <input id="to" type="text" required placeholder="Berlin, dworzec g≈Ç√≥wny">
            </div>
          </div>

          <div class="form-row" style="margin-top:10px;">
            <div class="col">
              <label for="date">Data i godzina</label>
              <input id="date" type="datetime-local" required>
            </div>
            <div class="col">
              <label for="people">Liczba os√≥b</label>
              <input id="people" type="number" value="1" min="1" required>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="notes">Uwagi (opcjonalnie)</label>
            <textarea id="notes" placeholder="Baga≈º, dzieci, specjalne potrzeby..."></textarea>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; align-items:center;">
            <button type="submit" class="submit">Wy≈õlij rezerwacjƒô</button>
            <div class="muted" id="formStatus"></div>
          </div>

          <p class="muted" style="margin-top:10px;">Po wys≈Çaniu rezerwacji ‚Äî jest ona zapisywana lokalnie (kierowca widzi po zalogowaniu). Mo≈ºesz te≈º wys≈Çaƒá e-mail (EmailJS) je≈õli skonfigurujesz.</p>
        </form>
      </div>

      <!-- Mapa -->
      <div class="card" style="margin-top:18px;">
        <h2>Lokalizacja ‚Äî podglƒÖd trasy</h2>
        <p class="small muted">Mapa pokazuje trasƒô/pozycjƒô kierowcy. Wklej sw√≥j klucz Google Maps w polu JS poni≈ºej, by w≈ÇƒÖczyƒá pe≈ÇnƒÖ funkcjonalno≈õƒá (Directions, marker kierowcy).</p>

        <div id="mapsWrap" style="margin-top:10px;">
          <!-- Fallback iframe embed map (will be replaced by JS map if key provided) -->
          <iframe id="mapEmbed" src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d24559.37856504603!2d16.900000!3d52.400000!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1" style="width:100%;height:360px;border:0;border-radius:10px;"></iframe>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <input id="driverLat" type="text" placeholder="lat kierowcy (np. 52.2297)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white);" />
            <input id="driverLng" type="text" placeholder="lng kierowcy (np. 21.0122)" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white);" />
            <button id="showDriverBtn" class="btn">Poka≈º kierowcƒô</button>
          </div>
          <div class="muted" style="margin-top:8px;font-size:13px;">Uwaga: aby rzeczywi≈õcie ≈õledziƒá kierowcƒô w czasie rzeczywistym potrzebny jest backend lub po≈ÇƒÖczenie z urzƒÖdzeniem GPS ‚Äî to mock w wersji MVP.</div>
        </div>
      </div>

      <!-- Opinie -->
      <div id="opinie" class="card" style="margin-top:18px;">
        <h2>Opinie klient√≥w</h2>
        <div class="opinie-wrap">
          <div id="opiniaText" class="opinie">≈Åadowanie opinii...</div>
          <div class="chip">≈örednia: 4.9/5</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Sidebar ‚Äî info, trust, panel -->
    <aside>
      <div class="card" id="kierowca">
        <h2>O kierowcy</h2>
        <p><strong>Maniek</strong> ‚Äî spok√≥j za kierownicƒÖ, do≈õwiadczenie i odpowiedzialno≈õƒá. Ponad 10 lat praktyki na trasach lokalnych i miƒôdzynarodowych. Zawsze punktualny, dba o komfort pasa≈ºera i stan techniczny pojazdu.</p>
        <div style="margin-top:12px;" class="icons-row">
          <div class="icon-box"><div class="icon-emoji">üõ°Ô∏è</div><div class="small">Bezpiecze≈Ñstwo</div></div>
          <div class="icon-box"><div class="icon-emoji">üìç</div><div class="small">GPS / ≈öledzenie</div></div>
          <div class="icon-box"><div class="icon-emoji">üöò</div><div class="small">Komfort</div></div>
        </div>
      </div>

      <div class="card" id="bezpieczenstwo" style="margin-top:14px;">
        <h2>Bezpiecze≈Ñstwo</h2>
        <ul style="margin:0 0 0 18px;">
          <li>Regularne przeglƒÖdy techniczne</li>
          <li>Systemy ABS / ESP</li>
          <li>Kierowca z certyfikatem i do≈õwiadczeniem</li>
          <li>Auto dezynfekowane i czyste</li>
        </ul>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="panel-title">
          <h2>Panel kierowcy</h2>
          <span class="small muted">Dostƒôp lokalny</span>
        </div>
        <p class="small muted">Kierowca widzi rezerwacje po zalogowaniu (has≈Ço). Has≈Ço domy≈õlne: <strong><span id="secretPlaceholder">Maniek2024!Secure</span></strong></p>
        <button class="btn primary" id="openPanelMobile">Otw√≥rz Panel</button>

        <div id="panelArea" style="display:none; margin-top:12px;">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:6px;">
            <input id="panelPass" type="password" placeholder="Wprowad≈∫ has≈Ço" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--white);">
            <button id="panelLogin" class="btn">Zaloguj</button>
          </div>

          <div id="reservationsList" style="margin-top:12px;"></div>
          <div style="margin-top:10px;">
            <button id="exportCsv" class="btn ghost">Eksportuj CSV</button>
            <button id="clearAll" class="btn ghost" title="Usu≈Ñ wszystkie lokalne rezerwacje">Usu≈Ñ</button>
          </div>
        </div>
      </div>

    </aside>
  </div>
</main>

<!-- RULES + LANG SWITCH -->
<section id="rules" class="card" style="margin:28px auto; max-width:1100px;">
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:12px;">
    <img src="https://flagcdn.com/w40/pl.png" data-lang="pl" class="lang-flag" />
    <img src="https://flagcdn.com/w40/gb.png" data-lang="en" class="lang-flag" />
    <img src="https://flagcdn.com/w40/de.png" data-lang="de" class="lang-flag" />
    <img src="https://flagcdn.com/w40/nl.png" data-lang="nl" class="lang-flag" />
  </div>

  <div id="lang-pl" class="lang-block">
    <h2>Regulamin Strony</h2>
    <p>1. Strona s≈Çu≈ºy do prezentacji oferty oraz umo≈ºliwia kontakt i rezerwacjƒô przejazd√≥w.</p>
    <p>2. Wysy≈ÇajƒÖc formularz, u≈ºytkownik akceptuje zasady strony.</p>
    <p>3. Rezerwacja nie jest gwarancjƒÖ miejsca ‚Äî potwierdza jƒÖ kierowca.</p>
    <p>4. Dane przetwarzane sƒÖ zgodnie z RODO wy≈ÇƒÖcznie w celu kontaktu.</p>

    <h3 style="margin-top:14px;">Regulamin Bezpiecze≈Ñstwa Podr√≥≈ºy</h3>
    <p>‚Äì Pas bezpiecze≈Ñstwa obowiƒÖzkowy przez ca≈ÇƒÖ podr√≥≈º.</p>
    <p>‚Äì W poje≈∫dzie obowiƒÖzuje zakaz spo≈ºywania alkoholu i ≈õrodk√≥w odurzajƒÖcych.</p>
    <p>‚Äì Kierowca mo≈ºe odm√≥wiƒá przewozu pasa≈ºera stwarzajƒÖcego zagro≈ºenie.</p>
    <p>‚Äì Firma nie odpowiada za rzeczy pozostawione w poje≈∫dzie.</p>
  </div>

  <div id="lang-en" class="lang-block hidden">
    <h2>Website Terms</h2>
    <p>1. The website presents transport services and allows contact and booking.</p>
    <p>2. Submitting a form means accepting the terms.</p>
    <p>3. A booking request is not a confirmed seat ‚Äî the driver must confirm.</p>
    <p>4. Data is processed only for contact (GDPR compliant).</p>
    <h3 style="margin-top:14px;">Travel Safety Rules</h3>
    <p>‚Äì Seatbelts must remain fastened throughout the journey.</p>
    <p>‚Äì Alcohol and drugs are prohibited inside the vehicle.</p>
    <p>‚Äì The driver may refuse transport for safety reasons.</p>
    <p>‚Äì The company is not responsible for items left in the vehicle.</p>
  </div>

  <div id="lang-de" class="lang-block hidden">
    <h2>Website-Bestimmungen</h2>
    <p>1. Die Website dient zur Darstellung der Transportdienste und erm√∂glicht Kontaktaufnahme.</p>
    <p>2. Mit Absenden eines Formulars akzeptiert der Nutzer die Bedingungen.</p>
    <p>3. Eine Anfrage garantiert keinen Platz ‚Äî best√§tigt wird durch den Fahrer.</p>
    <p>4. Daten werden nur f√ºr Kontakt und Buchung gem√§√ü DSGVO verarbeitet.</p>
    <h3 style="margin-top:14px;">Reisesicherheitsregeln</h3>
    <p>‚Äì Sicherheitsgurte m√ºssen w√§hrend der gesamten Fahrt angelegt sein.</p>
    <p>‚Äì Alkohol und Drogen sind im Fahrzeug verboten.</p>
    <p>‚Äì Der Fahrer darf die Bef√∂rderung verweigern, wenn die Sicherheit gef√§hrdet ist.</p>
    <p>‚Äì Keine Haftung f√ºr verlorene Gegenst√§nde.</p>
  </div>

  <div id="lang-nl" class="lang-block hidden">
    <h2>Websitevoorwaarden</h2>
    <p>1. De website dient voor presentatie van diensten en contact.</p>
    <p>2. Door het formulier te verzenden accepteert de gebruiker de voorwaarden.</p>
    <p>3. Een aanvraag is geen garantie ‚Äî bevestiging volgt door de chauffeur.</p>
    <p>4. Gegevens worden verwerkt volgens de AVG.</p>
    <h3 style="margin-top:14px;">Reisveiligheidsregels</h3>
    <p>‚Äì Veiligheidsgordels verplicht tijdens de hele rit.</p>
    <p>‚Äì Alcohol en drugs zijn verboden in het voertuig.</p>
    <p>‚Äì Chauffeur mag vervoer weigeren bij onveilige situaties.</p>
    <p>‚Äì Geen aansprakelijkheid voor verloren spullen.</p>
  </div>
</section>

<!-- PARTNERS -->
<section id="partners" class="card" style="margin:24px auto; max-width:1100px;">
  <h2 style="text-align:center;">Nasi Partnerzy</h2>
  <p style="text-align:center;color:var(--muted);margin-bottom:18px;">Wsp√≥≈Çpracujemy z firmami, kt√≥re gwarantujƒÖ najwy≈ºszƒÖ jako≈õƒá, bezpiecze≈Ñstwo i profesjonalizm.</p>

  <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;">
    <div class="card" style="background:var(--glass)">
      <img src="https://dummyimage.com/300x80/cccccc/000000&text=Partner+1" style="width:100%;border-radius:8px;" />
    </div>
    <div class="card" style="background:var(--glass)">
      <img src="https://dummyimage.com/300x80/cccccc/000000&text=Partner+2" style="width:100%;border-radius:8px;" />
    </div>
    <div class="card" style="background:var(--glass)">
      <img src="https://dummyimage.com/300x80/cccccc/000000&text=Reklama+1" style="width:100%;border-radius:8px;" />
    </div>
    <div class="card" style="background:var(--glass)">
      <img src="https://dummyimage.com/300x80/cccccc/000000&text=Reklama+2" style="width:100%;border-radius:8px;" />
    </div>
  </div>
</section>

<footer>
  <div class="container">
    <div class="small">¬© <span id="curYear"></span> Maniek ‚Äî Pewny Przew√≥z ‚Äî Kontakt: po wys≈Çaniu rezerwacji Maniek oddzwoni.</div>
  </div>
</footer>

<div class="ribbon">Zaufany przewo≈∫nik</div>

<!-- CHATBOT WIDGET (MVP) -->
<div id="chatbot-widget" aria-hidden="false">
  <div id="chatbot-header">
    <span>ManiekBot ‚Äî pomagam w rezerwacjach</span>
    <button id="chatbot-close" style="background:transparent;border:none;font-weight:700;cursor:pointer;">‚úï</button>
  </div>
  <div id="chatbot-messages" role="log" aria-live="polite"></div>
  <div id="chatbot-input">
    <input id="chatbot-input-field" placeholder="Napisz: 'Berlin ‚Üí Monachium' albo 'Wycena'..." />
    <button id="chatbot-send-btn">Wy≈õlij</button>
  </div>
</div>

<script>
/* ===================== CONFIG - WPI≈öC TU SWOJE KODY (opcjonalne) =====================
   - GOOGLE_MAPS_API_KEY: je≈õli wkleisz, uruchomi siƒô JS Maps (Directions, Distance Matrix).
   - EMAILJS_USER_ID, EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID: je≈õli wkleisz, formularz wy≈õle e-mail.
   - Je≈õli nie chcesz, zostaw puste i wszystko dzia≈Ça w trybie lokalnym (MVP).
============================================================================== */
const CONFIG = {
  GOOGLE_MAPS_API_KEY: '', // <-- Wklej sw√≥j Google Maps JS API key tutaj (opcjonalne)
  EMAILJS_USER_ID: '',     // <-- Wklej EmailJS user id (opcjonalne)
  EMAILJS_SERVICE_ID: '',  // <-- EmailJS Service ID
  EMAILJS_TEMPLATE_ID: ''  // <-- EmailJS Template ID
};
/* ========================================================================== */

document.getElementById('curYear').textContent = new Date().getFullYear();

/* ===================== OPINIE ROTATOR ===================== */
const opinie = [
  "‚≠ê ‚ÄûKierowca jak z≈Çoto! Spok√≥j i pe≈Çna kultura.‚Äù",
  "‚≠ê ‚ÄûJecha≈Çem do Niemiec ‚Äî zero stresu, pe≈Çen komfort.‚Äù",
  "‚≠ê ‚ÄûBezpiecznie, czysto i zawsze na czas. Polecam!‚Äù",
  "‚≠ê ‚ÄûManiek to kierowca, kt√≥ry naprawdƒô dba o ludzi.‚Äù"
];
let opinIndex = 0;
function showOpinion(){ document.getElementById('opiniaText').textContent = opinie[opinIndex]; opinIndex=(opinIndex+1)%opinie.length; }
showOpinion(); setInterval(showOpinion,4500);

/* ===================== LOCAL RESERVATIONS (localStorage) ===================== */
const STORAGE_KEY = 'maniek_reservations_v1';
function loadReservations(){ try{ const d = localStorage.getItem(STORAGE_KEY); return d?JSON.parse(d):[] }catch(e){return[]}}
function saveReservations(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)) }

/* handle booking form */
const form = document.getElementById('bookingForm');
const formStatus = document.getElementById('formStatus');

if(CONFIG.EMAILJS_USER_ID) {
  try{ emailjs.init(CONFIG.EMAILJS_USER_ID); } catch(e){ console.warn('EmailJS init failed', e); }
}

form.addEventListener('submit', function(e){
  e.preventDefault();
  const r = {
    id: 'r_' + Date.now(),
    name: document.getElementById('name').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    email: document.getElementById('email').value.trim(),
    from: document.getElementById('from').value.trim(),
    to: document.getElementById('to').value.trim(),
    date: document.getElementById('date').value,
    people: document.getElementById('people').value,
    notes: document.getElementById('notes').value.trim(),
    status: 'pending',
    created_at: new Date().toISOString()
  };

  if(!r.name || !r.phone || !r.from || !r.to || !r.date){
    formStatus.textContent = 'Wype≈Çnij wszystkie wymagane pola.';
    setTimeout(()=>formStatus.textContent='',3500);
    return;
  }

  const arr = loadReservations();
  arr.unshift(r);
  saveReservations(arr);

  // EMAIL via EmailJS if configured
  if(CONFIG.EMAILJS_SERVICE_ID && CONFIG.EMAILJS_TEMPLATE_ID && CONFIG.EMAILJS_USER_ID) {
    emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
      name: r.name, phone: r.phone, email: r.email||'Nie podano', from: r.from, to: r.to,
      date: new Date(r.date).toLocaleString(), people: r.people, notes: r.notes||'Brak uwag'
    }).then(()=> {
      formStatus.textContent = 'Rezerwacja zapisana i e-mail wys≈Çany!';
      form.reset();
      setTimeout(()=>formStatus.textContent='',4200);
      renderReservationsTable();
    }, err => {
      console.error('EmailJS error', err);
      formStatus.textContent = 'Rezerwacja zapisana, ale b≈ÇƒÖd wysy≈Çki e-mail.';
      form.reset();
      setTimeout(()=>formStatus.textContent='',4200);
      renderReservationsTable();
    });
  } else {
    formStatus.textContent = 'Rezerwacja zapisana (lokalnie).';
    form.reset();
    setTimeout(()=>formStatus.textContent='',2500);
    renderReservationsTable();
  }
});

/* Panel kierowcy */
const panelArea = document.getElementById('panelArea');
const panelLoginBtn = document.getElementById('panelLogin');
const panelPassInput = document.getElementById('panelPass');
const openPanelBtn = document.getElementById('openPanelBtn');
const openPanelMobile = document.getElementById('openPanelMobile');
const reservationsList = document.getElementById('reservationsList');

function showPanelUI(){ panelArea.style.display='block'; panelPassInput.focus(); }
function hidePanelUI(){ panelArea.style.display='none'; }

openPanelBtn.addEventListener('click', ()=>{ showPanelUI(); window.scrollTo({top:0,behavior:'smooth'}); });
openPanelMobile.addEventListener('click', ()=>{ showPanelUI(); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); });

panelLoginBtn.addEventListener('click', ()=> {
  const pass = panelPassInput.value || '';
  if(pass === document.getElementById('secretPlaceholder').textContent){
    panelPassInput.value = '';
    renderReservationsTable();
    panelPassInput.placeholder = 'Zalogowano';
    panelLoginBtn.textContent = 'Od≈õwie≈º';
  } else {
    alert('B≈Çƒôdne has≈Ço.');
  }
});

function renderReservationsTable(){
  const arr = loadReservations();
  if(arr.length===0){
    reservationsList.innerHTML = '<div class="small muted">Brak rezerwacji.</div>';
    return;
  }
  let html = '<div style="overflow:auto;"><table><thead><tr><th>Imiƒô</th><th>Tel</th><th>Trasa</th><th>Data</th><th>Os√≥b</th><th>Uwagi</th><th>Status</th></tr></thead><tbody>';
  arr.forEach(r=>{
    html += `<tr id="${r.id}"><td>${escapeHtml(r.name)}</td><td>${escapeHtml(r.phone)}</td><td>${escapeHtml(r.from)} ‚Üí ${escapeHtml(r.to)}</td><td>${new Date(r.date).toLocaleString()}</td><td>${escapeHtml(r.people)}</td><td>${escapeHtml(r.notes)}</td><td><select data-id="${r.id}" onchange="changeStatus(this)"><option ${r.status==='pending'?'selected':''}>pending</option><option ${r.status==='accepted'?'selected':''}>accepted</option><option ${r.status==='rejected'?'selected':''}>rejected</option></select></td></tr>`;
  });
  html += '</tbody></table></div>';
  reservationsList.innerHTML = html;
}
window.changeStatus = function(sel){
  const id = sel.dataset.id;
  const newStatus = sel.value;
  let arr = loadReservations();
  arr = arr.map(r => r.id===id ? Object.assign({}, r, {status:newStatus}) : r);
  saveReservations(arr);
  renderReservationsTable();
};

document.getElementById('exportCsv').addEventListener('click', ()=> {
  const arr = loadReservations();
  if(arr.length===0){ alert('Brak rezerwacji do eksportu.'); return; }
  const header = ['id','name','phone','email','from','to','date','people','notes','status','created_at'];
  const rows = arr.map(r => header.map(h => `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','));
  const csv = [header.join(','), ...rows].join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'rezerwacje_maniek.csv'; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
});
document.getElementById('clearAll').addEventListener('click', ()=>{
  if(!confirm('UsunƒÖƒá wszystkie lokalne rezerwacje?')) return;
  localStorage.removeItem(STORAGE_KEY);
  renderReservationsTable();
});

renderReservationsTable();

function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

/* ===================== MAPS (MVP) ===================== */
/* Behavior:
   - If CONFIG.GOOGLE_MAPS_API_KEY is provided, JS will load Google Maps and enable:
       * Map with DirectionsService between 'from' and 'to'
       * Driver marker updated using inputs (driverLat/driverLng)
       * Distance & duration lookup via DistanceMatrix
   - Otherwise we fallback to iframe embed updated by updateMapRoute(from,to)
*/
function updateMapRoute(from, to){
  if(!from || !to) return;
  if(CONFIG.GOOGLE_MAPS_API_KEY && window.google && window.directionsService){
    // Use DirectionsService (if initialized)
    calculateAndDisplayRoute(from,to);
    return;
  }
  // fallback -> change iframe src using Embed Directions API (requires key if you want route mode)
  const mapUrl = `https://www.google.com/maps/embed/v1/directions?key=${CONFIG.GOOGLE_MAPS_API_KEY || ''}&origin=${encodeURIComponent(from)}&destination=${encodeURIComponent(to)}&language=pl`;
  document.getElementById('mapEmbed').src = mapUrl;
}

/* monitor blur events on from/to to update embed or JS map */
document.getElementById('from').addEventListener('blur', ()=> {
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  if(from && to) updateMapRoute(from,to);
});
document.getElementById('to').addEventListener('blur', ()=> {
  const from = document.getElementById('from').value;
  const to = document.getElementById('to').value;
  if(from && to) updateMapRoute(from,to);
});

/* Driver marker mock */
document.getElementById('showDriverBtn').addEventListener('click', ()=> {
  const lat = parseFloat(document.getElementById('driverLat').value);
  const lng = parseFloat(document.getElementById('driverLng').value);
  if(CONFIG.GOOGLE_MAPS_API_KEY && window.google && window.driverMarker){
    const pos = {lat:lat, lng:lng};
    window.driverMarker.setPosition(pos);
    window.mainMap.setCenter(pos);
    alert('Pinezka kierowcy ustawiona na mapie (JS).');
  } else {
    if(isFinite(lat) && isFinite(lng)){
      const embed = document.getElementById('mapEmbed');
      embed.src = `https://www.google.com/maps/embed/v1/view?key=${CONFIG.GOOGLE_MAPS_API_KEY||''}&center=${lat},${lng}&zoom=12&maptype=roadmap`;
      alert('Pinezka (embed) ustawiona ‚Äî w trybie fallback.');
    } else {
      alert('Wprowad≈∫ poprawne wsp√≥≈Çrzƒôdne kierowcy.');
    }
  }
});

/* If user provided GOOGLE_MAPS_API_KEY, dynamically load JS API and init map functions */
if(CONFIG.GOOGLE_MAPS_API_KEY){
  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${CONFIG.GOOGLE_MAPS_API_KEY}&libraries=places`;
  s.defer = true;
  s.onload = () => initGoogleMaps();
  document.head.appendChild(s);
}

/* Google Maps functions (if key available) */
function initGoogleMaps(){
  // create map
  const mapDiv = document.createElement('div');
  mapDiv.id = 'jsMap';
  mapDiv.style.width = '100%';
  mapDiv.style.height = '360px';
  mapDiv.style.borderRadius = '10px';
  const parent = document.getElementById('mapsWrap');
  const iframe = document.getElementById('mapEmbed');
  iframe.style.display = 'none';
  parent.prepend(mapDiv);

  window.mainMap = new google.maps.Map(mapDiv, { zoom:10, center:{lat:52.2297,lng:21.0122} });
  window.directionsService = new google.maps.DirectionsService();
  window.directionsRenderer = new google.maps.DirectionsRenderer({ map: window.mainMap, suppressMarkers:false });
  window.distanceService = new google.maps.DistanceMatrixService();

  // driver marker
  window.driverMarker = new google.maps.Marker({ position:{lat:52.2297,lng:21.0122}, map:window.mainMap, title:'Maniek - pozycja' });

  window.calculateAndDisplayRoute = function(origin, destination){
    directionsService.route({ origin, destination, travelMode: google.maps.TravelMode.DRIVING }, (res, status) => {
      if(status === 'OK'){
        directionsRenderer.setDirections(res);
        // distance & duration from legs
        const leg = res.routes[0].legs[0];
        const distKm = (leg.distance.value / 1000).toFixed(1);
        const dur = leg.duration.text;
        alert(`Trasa: ${distKm} km, czas: ${dur}`);
      } else {
        console.warn('Directions error', status);
        alert('B≈ÇƒÖd pobierania trasy: ' + status);
      }
    });
  };
}

/* ===================== SIMPLE CHATBOT (client-side MVP) ===================== */
/* This chatbot is intentionally client-side so you can use it without backend.
   It uses:
   - FAQ matching,
   - route recognition "A -> B" (calls Maps JS if available or uses iframe fallback),
   - can start a reservation flow and generate mailto: or call EmailJS if configured.
*/
const botMessages = document.getElementById('chatbot-messages');
const botInput = document.getElementById('chatbot-input-field');
const botSend = document.getElementById('chatbot-send-btn');
const botClose = document.getElementById('chatbot-close');

const chatbotKnowledge = {
  welcome: "Witaj! Jestem ManiekBot. Mogƒô podaƒá szacunk trasy, sprawdziƒá dostƒôpno≈õƒá (po pod≈ÇƒÖczeniu systemu) i pom√≥c wys≈Çaƒá zapytanie o rezerwacjƒô. Napisz np. 'Berlin ‚Üí Monachium', 'Wycena', 'Wolny termin 15.11.2025' lub 'Rezerwacja'.",
  faqs:[
    {q:"rezerwacja|jak zam√≥wiƒá", a:"Aby zarezerwowaƒá: podaj trasƒô, datƒô i telefon. Mogƒô zapisaƒá rezerwacjƒô lokalnie lub wygenerowaƒá e-mail."},
    {q:"cena|koszt|ile kosztuje", a:"Ceny liczymy na podstawie trasy. Napisz trasƒô, np. 'Berlin ‚Üí Monachium' ‚Äî obliczƒô przybli≈ºonƒÖ odleg≈Ço≈õƒá i czas."},
    {q:"kontakt|telefon|mail", a:"Kontakt: pistrakiewicz@gmail.com, tel: +49 694 526 240 / +49 1516 3675 548."},
    {q:"termin|wolny|dostƒôpno≈õƒá", a:"Sprawdzanie dostƒôpno≈õci wymaga podpiƒôcia systemu rezerwacji. Na MVP mo≈ºesz wys≈Çaƒá zapytanie ‚Äî kierowca oddzwoni."}
  ]
};

let chatState = 0; // 0 = idle, 1..n = reservation collection
let chatData = {};

function botAdd(msg, who='bot'){
  const d = document.createElement('div');
  d.className = 'chat-msg ' + (who==='bot' ? 'chat-bot' : 'chat-user');
  d.innerHTML = msg;
  botMessages.appendChild(d);
  botMessages.scrollTop = botMessages.scrollHeight;
}

function botStart(){
  botMessages.innerHTML = '';
  botAdd(chatbotKnowledge.welcome);
}
botStart();

function processBotInput(text){
  if(!text || !text.trim()) return;
  botAdd(escapeHtml(text), 'user');

  const lower = text.toLowerCase();

  // If in reservation collection
  if(chatState > 0){
    handleChatReservation(text);
    return;
  }

  // check FAQ
  const faq = chatbotKnowledge.faqs.find(f => f.q.split('|').some(k => lower.includes(k)));
  if(faq){
    botAdd(faq.a);
    return;
  }

  // route detection a -> b (supports ->, ‚Üí or -> or " to ")
  let match = text.match(/(.+?)(?:->|‚Üí|->| to | do | - )(.+)/i);
  if(!match) match = text.match(/(.+)\s+[-‚Üí]\s+(.+)/);
  if(match){
    const from = match[1].trim();
    const to = match[2].trim();
    botAdd(`Sprawdzam trasƒô z <strong>${escapeHtml(from)}</strong> do <strong>${escapeHtml(to)}</strong>...`);
    // If Google Maps JS available -> calculate route
    if(window.calculateAndDisplayRoute){
      calculateAndDisplayRoute(from, to);
      botAdd(`Je≈õli chcesz otrzymaƒá wycenƒô lub zapisaƒá rezerwacjƒô, napisz "Rezerwacja".`);
    } else {
      // fallback to embed + distance estimate (fake or DistanceMatrix if key+api)
      if(CONFIG.GOOGLE_MAPS_API_KEY){
        // DistanceMatrix requires server key (CORS) ‚Äì we'll use embed as fallback and random estimate
      }
      const distance = Math.floor(Math.random()*700)+80;
      const mins = Math.floor(distance/80*60);
      botAdd(`Trasa ~ <strong>${distance} km</strong>, szacowany czas: <strong>${Math.floor(mins/60)}h ${mins%60}min</strong>. <br><a target="_blank" href="https://www.google.com/maps/dir/${encodeURIComponent(from)}/${encodeURIComponent(to)}">Poka≈º trasƒô w Google Maps</a>`);
      botAdd(`Je≈õli chcesz wyceny lub rezerwacji, napisz "Rezerwacja".`);
    }
    return;
  }

  // "wycena" trigger
  if(lower.includes('wycena') || lower.includes('cena') || lower.includes('koszt')){
    botAdd('Aby podaƒá wycenƒô, podaj trasƒô w formacie: <em>Miasto A ‚Üí Miasto B</em> (np. Berlin ‚Üí Monachium).');
    return;
  }

  // "rezerwacja" trigger
  if(lower.includes('rezerwacja') || lower.includes('zam√≥w') || lower.includes('wycena')){
    chatState = 1;
    chatData = {};
    botAdd('OK ‚Äî zaczynam zbieraƒá dane. Podaj proszƒô swoje imiƒô i nazwisko:');
    return;
  }

  // default
  botAdd("Nie jestem pewien ‚Äî spr√≥buj zapytaƒá o trasƒô (np. 'Berlin ‚Üí Monachium'), 'Rezerwacja' lub 'FAQ'.");
}

function handleChatReservation(input){
  switch(chatState){
    case 1:
      if(input.trim().length < 3){ botAdd('Podaj poprawne imiƒô i nazwisko.'); return; }
      chatData.name = input.trim(); chatState = 2; botAdd('Podaj adres e-mail (albo wpisz "brak"):'); break;
    case 2:
      if(input.trim().toLowerCase() !== 'brak' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(input.trim())){ botAdd('Podaj poprawny e-mail lub wpisz "brak".'); return; }
      chatData.email = input.trim().toLowerCase() === 'brak' ? '' : input.trim();
      chatState = 3; botAdd('Podaj numer telefonu:'); break;
    case 3:
      chatData.phone = input.trim();
      chatState = 4; botAdd('Podaj trasƒô (SkƒÖd ‚Üí DokƒÖd):'); break;
    case 4:
      chatData.route = input.trim();
      chatState = 5; botAdd('Podaj datƒô i godzinƒô (np. 2025-11-15 08:00):'); break;
    case 5:
      chatData.datetime = input.trim();
      chatState = 6; botAdd('Opcjonalne uwagi do przejazdu (np. baga≈º, dzieci) lub wpisz "brak":'); break;
    case 6:
      chatData.notes = input.trim();
      // save locally
      const arr = loadReservations();
      const rec = { id:'r_'+Date.now(), name:chatData.name, phone:chatData.phone, email:chatData.email, from: chatData.route.split(/->|‚Üí|to| - | to | do /i)[0]||'', to: chatData.route.split(/->|‚Üí|to| - | to | do /i)[1]||'', date: chatData.datetime, people:1, notes:chatData.notes || '', status:'pending', created_at:new Date().toISOString() };
      arr.unshift(rec); saveReservations(arr); renderReservationsTable();
      botAdd('Rezerwacja zapisana lokalnie. Chcesz wys≈Çaƒá e-mail z zapytaniem? (tak/nie)');
      chatState = 7;
      break;
    case 7:
      if(input.trim().toLowerCase().startsWith('t')){
        // generate mailto (or use EmailJS if configured)
        const subject = encodeURIComponent(`Wycena / Rezerwacja od ${chatData.name}`);
        const body = encodeURIComponent(`Imiƒô i nazwisko: ${chatData.name}\nTelefon: ${chatData.phone}\nE-mail: ${chatData.email || 'Brak'}\nTrasa: ${chatData.route}\nData: ${chatData.datetime}\nUwagi: ${chatData.notes || 'Brak'}`);
        if(CONFIG.EMAILJS_SERVICE_ID && CONFIG.EMAILJS_TEMPLATE_ID && CONFIG.EMAILJS_USER_ID){
          // try sending via EmailJS (not blocking)
          emailjs.send(CONFIG.EMAILJS_SERVICE_ID, CONFIG.EMAILJS_TEMPLATE_ID, {
            name: chatData.name, phone: chatData.phone, email: chatData.email||'Brak',
            from_to: chatData.route, date: chatData.datetime, notes: chatData.notes||'Brak'
          }).then(()=> botAdd('E-mail wys≈Çany! Kierowca skontaktuje siƒô wkr√≥tce.'), ()=> botAdd('B≈ÇƒÖd wysy≈Çki e-mail. Mo≈ºesz u≈ºyƒá mailto:'));
        } else {
          botAdd(`<a href="mailto:pistrakiewicz@gmail.com?subject=${subject}&body=${body}">Kliknij, by wys≈Çaƒá e-mail z zapytaniem</a>`);
        }
        // reset
        chatState = 0; chatData = {};
      } else {
        botAdd('OK ‚Äî rezerwacja zapisana lokalnie, kierowca oddzwoni ≈ºeby potwierdziƒá.');
        chatState = 0; chatData = {};
      }
      break;
  }
}

/* CHAT UI handlers */
botSend.addEventListener('click', ()=>{ processBotInput(botInput.value); botInput.value=''; botInput.focus(); });
botInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ processBotInput(botInput.value); botInput.value=''; }});
botClose.addEventListener('click', ()=>{ document.getElementById('chatbot-widget').style.display='none'; });

/* ===================== LANGUAGE SWITCH FOR RULES ===================== */
const blocks = document.querySelectorAll(".lang-block");
const flags = document.querySelectorAll(".lang-flag");
function showLang(lang){ blocks.forEach(b=>b.classList.add('hidden')); document.getElementById('lang-'+lang).classList.remove('hidden'); }
flags.forEach(f=> f.addEventListener('click', ()=>{ const l=f.dataset.lang; showLang(l); }));
// initial language detection
const userLang = (navigator.language||'pl').slice(0,2);
if(['pl','en','de','nl'].includes(userLang)) showLang(userLang); else showLang('pl');

/* ===================== UTILS ===================== */
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; }); }

</script>

</body>
</html>

